# -*- coding: utf-8 -*-

# Form implementation generated from reading ui file '.\OpenPGP\ui\generate_delete_window.ui'
#
# Created by: PyQt5 UI code generator 5.15.10
#
# WARNING: Any manual changes made to this file will be lost when pyuic5 is
# run again.  Do not edit this file unless you know what you are doing.


from PyQt5 import QtCore, QtGui, QtWidgets
from PyQt5.QtWidgets import QMessageBox
from OpenPGP.asymmetric_encryption.keys.privatekeyring import PrivateKeyring
from OpenPGP.asymmetric_encryption.keys import utilities
from OpenPGP.asymmetric_encryption.keys.privatekeyring import private_keyring
from OpenPGP.asymmetric_encryption.keys.publickeyring import public_keyring
from OpenPGP.users.users_db import usersDB
from OpenPGP.asymmetric_encryption.keys.privatekey import PrivateKey


class Ui_generate_delete_window(object):

    def open_error(self, error_message):
        msg = QMessageBox()
        msg.setIcon(QMessageBox.Critical)
        msg.setText(error_message)
        msg.setWindowTitle("Error!")
        msg.setStandardButtons(QMessageBox.Ok)
        msg.exec_()

    def open_generate_keys(self):
        self.passphrase.setEchoMode(QtWidgets.QLineEdit.Password)
        self.stackedWidget.setCurrentWidget(self.generate_keys_page)

    def generate_keys(self):
        name = self.name.text()
        email = self.email.text()
        key_size = int(self.key_size.currentText())
        passphrase = self.passphrase.text()

        if passphrase != usersDB.logged_in_user.password:
            self.open_error("Wrong password!")
            return

        keyID = private_keyring.generate_keys(name, email, key_size, passphrase)

        self.generated_label.setText(str(keyID))
        self.generated_text.show()
        self.generated_label.show()

    def delete_key(self, key: PrivateKey):
        if usersDB.logged_in_user.password != self.passphrase_delete.text():
            self.open_error("Wrong password!")
            return
        private_keyring.remove_key(key.userID, key.keyID)
        public_keyring.remove_key(key.userID, key.keyID)
        self.open_delete_keys()

    def open_delete_keys(self):
        row = 0
        logged_in_userID = usersDB.logged_in_user.name + ":" + usersDB.logged_in_user.email
        self.delete_table.setRowCount(len(private_keyring.get_keys_by_userID(logged_in_userID)))

        for key in private_keyring.get_keys_by_userID(logged_in_userID):
            self.delete_table.setItem(row, 0, QtWidgets.QTableWidgetItem(str(key.timestamp)))
            self.delete_table.setItem(row, 1, QtWidgets.QTableWidgetItem(str(key.keyID)))
            self.delete_table.setItem(row, 2, QtWidgets.QTableWidgetItem(key.repr_public_key()))
            self.delete_table.setItem(row, 3, QtWidgets.QTableWidgetItem(str(key.encrypted_private_key)))
            self.delete_table.setItem(row, 4, QtWidgets.QTableWidgetItem(str(key.userID)))
            button = QtWidgets.QPushButton("Delete")
            # ova donja crta mora da se prosledi jer to hvata neko False iz connect poziva
            # i onda se sa tim lepo u k upise key
            button.clicked.connect(lambda _, k=key: self.delete_key(k))
            self.delete_table.setCellWidget(row, 5, button)
            row += 1

        # self.delete_table.resizeColumnsToContents()
        self.stackedWidget.setCurrentWidget(self.delete_keys_page)
    def setupUi(self, generate_delete_window):
        generate_delete_window.setObjectName("generate_delete_window")
        generate_delete_window.resize(809, 697)
        self.centralwidget = QtWidgets.QWidget(generate_delete_window)
        self.centralwidget.setObjectName("centralwidget")
        self.horizontalLayoutWidget = QtWidgets.QWidget(self.centralwidget)
        self.horizontalLayoutWidget.setGeometry(QtCore.QRect(-10, 0, 821, 80))
        self.horizontalLayoutWidget.setObjectName("horizontalLayoutWidget")
        self.horizontalLayout = QtWidgets.QHBoxLayout(self.horizontalLayoutWidget)
        self.horizontalLayout.setContentsMargins(100, 0, 100, 0)
        self.horizontalLayout.setObjectName("horizontalLayout")
        self.generate_button = QtWidgets.QPushButton(self.horizontalLayoutWidget)
        self.generate_button.setObjectName("generate_button")
        self.horizontalLayout.addWidget(self.generate_button)
        spacerItem = QtWidgets.QSpacerItem(98, 75, QtWidgets.QSizePolicy.Minimum, QtWidgets.QSizePolicy.Expanding)
        self.horizontalLayout.addItem(spacerItem)
        self.delete_button = QtWidgets.QPushButton(self.horizontalLayoutWidget)
        self.delete_button.setObjectName("delete_button")
        self.horizontalLayout.addWidget(self.delete_button)
        self.stackedWidget = QtWidgets.QStackedWidget(self.centralwidget)
        self.stackedWidget.setGeometry(QtCore.QRect(0, 80, 811, 571))
        self.stackedWidget.setObjectName("stackedWidget")
        self.empty = QtWidgets.QWidget()
        self.empty.setObjectName("empty")
        self.stackedWidget.addWidget(self.empty)
        self.generate_keys_page = QtWidgets.QWidget()
        self.generate_keys_page.setObjectName("generate_keys_page")
        self.generate_key_button = QtWidgets.QPushButton(self.generate_keys_page)
        self.generate_key_button.setGeometry(QtCore.QRect(290, 320, 211, 51))
        self.generate_key_button.setObjectName("generate_key_button")
        self.label_5 = QtWidgets.QLabel(self.generate_keys_page)
        self.label_5.setGeometry(QtCore.QRect(170, 10, 491, 41))
        font = QtGui.QFont()
        font.setPointSize(12)
        self.label_5.setFont(font)
        self.label_5.setAlignment(QtCore.Qt.AlignCenter)
        self.label_5.setObjectName("label_5")
        self.verticalLayoutWidget = QtWidgets.QWidget(self.generate_keys_page)
        self.verticalLayoutWidget.setGeometry(QtCore.QRect(110, 60, 601, 243))
        self.verticalLayoutWidget.setObjectName("verticalLayoutWidget")
        self.verticalLayout = QtWidgets.QVBoxLayout(self.verticalLayoutWidget)
        self.verticalLayout.setContentsMargins(0, 0, 0, 0)
        self.verticalLayout.setObjectName("verticalLayout")
        self.label = QtWidgets.QLabel(self.verticalLayoutWidget)
        font = QtGui.QFont()
        font.setPointSize(10)
        font.setBold(False)
        font.setWeight(50)
        self.label.setFont(font)
        self.label.setFrameShape(QtWidgets.QFrame.NoFrame)
        self.label.setObjectName("label")
        self.verticalLayout.addWidget(self.label)
        self.name = QtWidgets.QLineEdit(self.verticalLayoutWidget)
        font = QtGui.QFont()
        font.setPointSize(10)
        self.name.setFont(font)
        self.name.setReadOnly(True)
        self.name.setObjectName("name")
        self.verticalLayout.addWidget(self.name)
        self.label_2 = QtWidgets.QLabel(self.verticalLayoutWidget)
        font = QtGui.QFont()
        font.setPointSize(10)
        self.label_2.setFont(font)
        self.label_2.setObjectName("label_2")
        self.verticalLayout.addWidget(self.label_2)
        self.email = QtWidgets.QLineEdit(self.verticalLayoutWidget)
        font = QtGui.QFont()
        font.setPointSize(10)
        self.email.setFont(font)
        self.email.setReadOnly(True)
        self.email.setObjectName("email")
        self.verticalLayout.addWidget(self.email)
        self.label_3 = QtWidgets.QLabel(self.verticalLayoutWidget)
        font = QtGui.QFont()
        font.setPointSize(10)
        self.label_3.setFont(font)
        self.label_3.setObjectName("label_3")
        self.verticalLayout.addWidget(self.label_3)
        self.key_size = QtWidgets.QComboBox(self.verticalLayoutWidget)
        font = QtGui.QFont()
        font.setPointSize(10)
        self.key_size.setFont(font)
        self.key_size.setObjectName("key_size")
        self.key_size.addItem("")
        self.key_size.addItem("")
        self.verticalLayout.addWidget(self.key_size)
        self.label_4 = QtWidgets.QLabel(self.verticalLayoutWidget)
        font = QtGui.QFont()
        font.setPointSize(10)
        self.label_4.setFont(font)
        self.label_4.setObjectName("label_4")
        self.verticalLayout.addWidget(self.label_4)
        self.passphrase = QtWidgets.QLineEdit(self.verticalLayoutWidget)
        font = QtGui.QFont()
        font.setPointSize(10)
        self.passphrase.setFont(font)
        self.passphrase.setObjectName("passphrase")
        self.verticalLayout.addWidget(self.passphrase)
        self.horizontalLayoutWidget_2 = QtWidgets.QWidget(self.generate_keys_page)
        self.horizontalLayoutWidget_2.setGeometry(QtCore.QRect(110, 420, 601, 80))
        self.horizontalLayoutWidget_2.setObjectName("horizontalLayoutWidget_2")
        self.generated_layout = QtWidgets.QHBoxLayout(self.horizontalLayoutWidget_2)
        self.generated_layout.setContentsMargins(0, 0, 0, 0)
        self.generated_layout.setObjectName("generated_layout")
        self.generated_text = QtWidgets.QLabel(self.horizontalLayoutWidget_2)
        font = QtGui.QFont()
        font.setPointSize(10)
        self.generated_text.setFont(font)
        self.generated_text.setObjectName("generated_text")
        self.generated_layout.addWidget(self.generated_text)
        self.generated_text.hide()
        self.generated_label = QtWidgets.QLabel(self.horizontalLayoutWidget_2)
        font = QtGui.QFont()
        font.setPointSize(10)
        self.generated_label.setFont(font)
        self.generated_label.setText("")
        self.generated_label.setObjectName("generated_label")
        self.generated_layout.addWidget(self.generated_label)
        self.stackedWidget.addWidget(self.generate_keys_page)
        self.delete_keys_page = QtWidgets.QWidget()
        self.delete_keys_page.setObjectName("delete_keys_page")
        self.delete_table = QtWidgets.QTableWidget(self.delete_keys_page)
        self.delete_table.setGeometry(QtCore.QRect(30, 70, 751, 411))
        font = QtGui.QFont()
        font.setPointSize(10)
        self.delete_table.setFont(font)
        self.delete_table.setObjectName("delete_table")
        self.delete_table.setColumnCount(6)
        self.delete_table.setRowCount(0)
        item = QtWidgets.QTableWidgetItem()
        self.delete_table.setHorizontalHeaderItem(0, item)
        item = QtWidgets.QTableWidgetItem()
        self.delete_table.setHorizontalHeaderItem(1, item)
        item = QtWidgets.QTableWidgetItem()
        self.delete_table.setHorizontalHeaderItem(2, item)
        item = QtWidgets.QTableWidgetItem()
        self.delete_table.setHorizontalHeaderItem(3, item)
        item = QtWidgets.QTableWidgetItem()
        self.delete_table.setHorizontalHeaderItem(4, item)
        item = QtWidgets.QTableWidgetItem()
        self.delete_table.setHorizontalHeaderItem(5, item)
        self.label_6 = QtWidgets.QLabel(self.delete_keys_page)
        self.label_6.setGeometry(QtCore.QRect(30, 30, 451, 21))
        font = QtGui.QFont()
        font.setPointSize(10)
        self.label_6.setFont(font)
        self.label_6.setObjectName("label_6")
        self.label_7 = QtWidgets.QLabel(self.delete_keys_page)
        self.label_7.setGeometry(QtCore.QRect(30, 491, 599, 23))
        font = QtGui.QFont()
        font.setPointSize(10)
        self.label_7.setFont(font)
        self.label_7.setObjectName("label_7")
        self.passphrase_delete = QtWidgets.QLineEdit(self.delete_keys_page)
        self.passphrase_delete.setGeometry(QtCore.QRect(30, 520, 599, 27))
        font = QtGui.QFont()
        font.setPointSize(10)
        self.passphrase_delete.setFont(font)
        self.passphrase_delete.setObjectName("passphrase_delete")
        self.passphrase_delete.setEchoMode(QtWidgets.QLineEdit.Password)
        self.stackedWidget.addWidget(self.delete_keys_page)
        generate_delete_window.setCentralWidget(self.centralwidget)
        self.menubar = QtWidgets.QMenuBar(generate_delete_window)
        self.menubar.setGeometry(QtCore.QRect(0, 0, 809, 26))
        self.menubar.setObjectName("menubar")
        generate_delete_window.setMenuBar(self.menubar)
        self.statusbar = QtWidgets.QStatusBar(generate_delete_window)
        self.statusbar.setObjectName("statusbar")
        generate_delete_window.setStatusBar(self.statusbar)

        self.generate_button.clicked.connect(lambda: self.open_generate_keys())
        self.generate_key_button.clicked.connect(lambda: self.generate_keys())
        self.delete_button.clicked.connect(lambda: self.open_delete_keys())
        self.name.setText(usersDB.logged_in_user.name)
        self.email.setText(usersDB.logged_in_user.email)

        self.retranslateUi(generate_delete_window)
        self.stackedWidget.setCurrentIndex(0)
        QtCore.QMetaObject.connectSlotsByName(generate_delete_window)

    def retranslateUi(self, generate_delete_window):
        _translate = QtCore.QCoreApplication.translate
        generate_delete_window.setWindowTitle(_translate("generate_delete_window", "Generate and delete keys"))
        self.generate_button.setText(_translate("generate_delete_window", "Generate keys"))
        self.delete_button.setText(_translate("generate_delete_window", "Delete keys"))
        self.generate_key_button.setText(_translate("generate_delete_window", "Generate"))
        self.label_5.setText(_translate("generate_delete_window", "Input required information to generate keys"))
        self.label.setText(_translate("generate_delete_window", "Name"))
        self.label_2.setText(_translate("generate_delete_window", "Email"))
        self.label_3.setText(_translate("generate_delete_window", "Choose key size"))
        self.key_size.setItemText(0, _translate("generate_delete_window", "1024"))
        self.key_size.setItemText(1, _translate("generate_delete_window", "2048"))
        self.label_4.setText(_translate("generate_delete_window", "Input passphrase"))
        self.generated_text.setText(_translate("generate_delete_window", "Generated with keyID"))
        item = self.delete_table.horizontalHeaderItem(0)
        item.setText(_translate("generate_delete_window", "Timestamp"))
        item = self.delete_table.horizontalHeaderItem(1)
        item.setText(_translate("generate_delete_window", "Key ID"))
        item = self.delete_table.horizontalHeaderItem(2)
        item.setText(_translate("generate_delete_window", "Public key"))
        item = self.delete_table.horizontalHeaderItem(3)
        item.setText(_translate("generate_delete_window", "Encrypted private key"))
        item = self.delete_table.horizontalHeaderItem(4)
        item.setText(_translate("generate_delete_window", "User ID"))
        item = self.delete_table.horizontalHeaderItem(5)
        item.setText(_translate("generate_delete_window", "Delete"))
        self.label_6.setText(_translate("generate_delete_window", "Select key for deletion"))
        self.label_7.setText(_translate("generate_delete_window", "Input passphrase"))


if __name__ == "__main__":
    import sys
    app = QtWidgets.QApplication(sys.argv)
    generate_delete_window = QtWidgets.QMainWindow()
    ui = Ui_generate_delete_window()
    ui.setupUi(generate_delete_window)
    generate_delete_window.show()
    sys.exit(app.exec_())
